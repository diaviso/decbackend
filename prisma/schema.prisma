generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  ADMIN
  USER
}

enum QuizDifficulty {
  FACILE
  MOYEN
  DIFFICILE
}

enum QuestionType {
  QCM
  QCU
}

enum TopicStatus {
  OUVERT
  FERME
  RESOLU
}

model User {
  id                String              @id @default(uuid())
  email             String              @unique
  password          String?
  firstName         String
  lastName          String
  country           String?
  city              String?
  role              UserRole            @default(USER)
  isEmailVerified   Boolean             @default(false)
  googleId          String?             @unique
  stars             Int                 @default(0)
  showInLeaderboard Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  emailVerifications EmailVerification[]
  passwordResets     PasswordReset[]
  articles          Article[]
  articleLikes      ArticleLike[]
  comments          Comment[]
  commentLikes      CommentLike[]
  forumTopics       ForumTopic[]
  forumComments     ForumComment[]
  forumCommentLikes ForumCommentLike[]
  quizAttempts      QuizAttempt[]

  @@map("users")
}

model EmailVerification {
  id        String   @id @default(uuid())
  userId    String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("email_verifications")
}

model PasswordReset {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_resets")
}

model Theme {
  id          String   @id @default(uuid())
  title       String
  description String
  position    Int      @unique
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  quizzes Quiz[]

  @@map("themes")
}

model Quiz {
  id              String         @id @default(uuid())
  themeId         String
  title           String
  description     String
  difficulty      QuizDifficulty
  timeLimit       Int
  passingScore    Int
  isFree          Boolean        @default(false)
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  theme     Theme         @relation(fields: [themeId], references: [id], onDelete: Cascade)
  questions Question[]
  attempts  QuizAttempt[]

  @@map("quizzes")
}

model Question {
  id         String         @id @default(uuid())
  quizId     String
  content    String
  type       QuestionType
  difficulty QuizDifficulty
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  
  quiz    Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  options Option[]

  @@map("questions")
}

model Option {
  id         String   @id @default(uuid())
  questionId String
  content    String
  isCorrect  Boolean  @default(false)
  createdAt  DateTime @default(now())
  
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("options")
}

model QuizAttempt {
  id          String   @id @default(uuid())
  userId      String
  quizId      String
  score       Int
  starsEarned Int      @default(0)
  completedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@map("quiz_attempts")
}

model BlogCategory {
  id        String    @id @default(uuid())
  name      String    @unique
  slug      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  articles Article[]

  @@map("blog_categories")
}

model Tag {
  id        String   @id @default(uuid())
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now())
  
  articles Article[]

  @@map("tags")
}

model Article {
  id         String   @id @default(uuid())
  authorId   String
  categoryId String
  title      String
  slug       String   @unique
  content    String
  excerpt    String?
  coverImage String?
  published  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  author   User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  category BlogCategory  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  tags     Tag[]
  comments Comment[]
  likes    ArticleLike[]

  @@map("articles")
}

model ArticleLike {
  id        String   @id @default(uuid())
  userId    String
  articleId String
  createdAt DateTime @default(now())
  
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([userId, articleId])
  @@map("article_likes")
}

model Comment {
  id        String   @id @default(uuid())
  articleId String
  userId    String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  article Article       @relation(fields: [articleId], references: [id], onDelete: Cascade)
  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  likes   CommentLike[]

  @@map("comments")
}

model CommentLike {
  id        String   @id @default(uuid())
  userId    String
  commentId String
  createdAt DateTime @default(now())
  
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  comment Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@map("comment_likes")
}

model ForumCategory {
  id        String   @id @default(uuid())
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now())
  
  topics ForumTopic[]

  @@map("forum_categories")
}

model ForumTopic {
  id         String      @id @default(uuid())
  authorId   String
  categoryId String
  title      String
  content    String
  status     TopicStatus @default(OUVERT)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  
  author   User            @relation(fields: [authorId], references: [id], onDelete: Cascade)
  category ForumCategory   @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  comments ForumComment[]

  @@map("forum_topics")
}

model ForumComment {
  id              String   @id @default(uuid())
  topicId         String
  userId          String
  parentCommentId String?
  content         String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  topic         ForumTopic         @relation(fields: [topicId], references: [id], onDelete: Cascade)
  user          User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  parentComment ForumComment?      @relation("CommentReplies", fields: [parentCommentId], references: [id], onDelete: Cascade)
  replies       ForumComment[]     @relation("CommentReplies")
  likes         ForumCommentLike[]

  @@map("forum_comments")
}

model ForumCommentLike {
  id        String   @id @default(uuid())
  userId    String
  commentId String
  createdAt DateTime @default(now())
  
  user    User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  comment ForumComment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@map("forum_comment_likes")
}
